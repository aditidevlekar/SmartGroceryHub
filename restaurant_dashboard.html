<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>Restaurant — Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root { --accent: #b91c1c; }
body { font-family: Inter, system-ui, sans-serif; background: #fff7f7; min-height: 100vh; overflow-x: hidden;}
header { background: linear-gradient(90deg, #ef4444, #b91c1c); color: white;}
.product {background: white; border-radius: 14px; overflow: hidden; display: flex; flex-direction: column; border: 1px solid #f2f2f2; box-shadow: 0 4px 14px #0001;}
.prod-media {width:100%;max-width:130px;aspect-ratio:1/1;height:auto;background:#f2f2f2; display:flex;justify-content:center;align-items:center;overflow:hidden;margin:13px auto 0 auto;}
.prod-media img{width:100%;height:100%;object-fit:cover;min-width:80px;min-height:80px;border-radius:8px;}
.prod-body {padding:14px;display:flex;flex-direction:column;gap:4px;}
.prod-actions {padding:12px; display:flex;gap:7px;flex-direction:column;}
.prod-btn {width:100%;padding:11px;border-radius:10px;font-size:15px;font-weight:600;text-align:center;}
.banner {position: fixed; left: 50%; top: 18px; transform: translateX(-50%); padding: 10px 14px; border-radius: 12px; opacity: 0; pointer-events: none; transition: all .3s ease; z-index: 200; font-size: 15px;}
.banner.show { opacity: 1; top: 30px; pointer-events: auto; }
.banner.success { background: #e6fff0; color: #059669;}
.banner.error { background: #ffe8ea; color: #b91c1c;}
#cartDrawer {position:fixed;left:0;bottom:-100%;width:100%;max-height:90vh;background:white;box-shadow: 0 -6px 20px #0003;border-radius:16px 16px 0 0;z-index:160;transition:.35s;display:flex;flex-direction:column;}
#cartDrawer.show{bottom:0;}
#drawerOverlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:150;opacity:0;pointer-events:none;transition:.3s;}
#drawerOverlay.show{opacity:1;pointer-events:auto;}
#chatPopup {position:fixed;inset:0;background:white;z-index:200;display:none;flex-direction:column;}
#chatPopup.show{display:flex;}
#chatWindow {flex:1;padding:16px;overflow-y:auto;background:#fafafa;}
.msg {padding:10px 14px;border-radius:14px;max-width:80%;margin-bottom:12px;white-space: pre-line;}
.msg.user{background:#ffe1e1;margin-left:auto;}
.msg.bot{background:#fff;border:1px solid #eee;margin-right:auto;}
#chatInputBar {padding:12px;border-top:1px solid #ddd;display:flex;gap:8px;}
#chatSendBtn {background:#b91c1c;color:white;padding:0 20px;border-radius:10px;}
</style>
</head>
<body>
<div id="banner" class="banner"></div>
<header class="p-4 flex justify-between items-center">
  <div class="text-lg font-semibold">Chef's Panel</div>
  <div class="flex gap-2 items-center">
    <button id="openChatbot" class="px-3 py-2 bg-white/20 rounded-lg text-sm">AI Chat</button>
    <button id="openCartBtn" class="px-3 py-2 bg-white/20 rounded-lg text-sm">Cart <span id="cartCount">(0)</span></button>
    <button id="logout" class="px-3 py-1 bg-white/20 rounded-lg text-sm">Logout</button>
  </div>
</header>
<div class="p-4 font-medium text-sm text-gray-600" id="userEmail"></div>
<main class="p-4 grid gap-6">
  <section class="card">
    <div class="flex gap-2 mb-4">
      <input id="searchInput" class="p-3 border rounded-lg w-full" placeholder="Search item or seller"/>
      <button id="searchBtn" class="px-4 py-2 rounded-lg border">Go</button>
    </div>
    <button id="menuSuggestBtn" class="mb-3 w-full px-4 py-2 rounded-lg bg-blue-600 text-white font-semibold">AI Menu Suggestions</button>
    <div id="marketplace" class="flex flex-col gap-4"></div>
  </section>
</main>
<div id="drawerOverlay"></div>
<div id="cartDrawer">
  <div class="p-4 border-b flex justify-between items-center">
    <div class="text-lg font-semibold">Your Cart</div>
    <button id="closeCart" class="text-xl text-red-600">&times;</button>
  </div>
  <div id="cartItems" class="flex-1 overflow-y-auto p-4"></div>
  <div class="p-4 border-t">
    <div class="flex justify-between"><span class="font-medium">Total:</span><span id="cartTotal" class="font-semibold text-green-700">₹0</span></div>
    <button id="checkoutBtn" class="w-full py-3 bg-green-600 text-white rounded-lg mt-3">Checkout</button>
  </div>
</div>
<div id="chatPopup">
  <div class="p-4 text-white bg-red-600 flex justify-between items-center">
    <strong>AI Recipe Assistant</strong>
    <button id="closeChatbot" class="text-xl">&times;</button>
  </div>
  <div id="chatWindow"></div>
  <div id="chatInputBar">
    <input id="chatInput" class="flex-1 border rounded-lg p-3" placeholder="Ask something..."/>
    <button id="chatSendBtn">Send</button>
  </div>
</div>
<!-- AI Menu Suggestion Popup -->
<div id="menuSuggestPopup" style="display:none;z-index:300;" class="fixed inset-0 flex items-end justify-center px-2 pb-9 bg-black/30">
  <div class="bg-white rounded-lg shadow-lg px-4 py-6 w-full max-w-xs mx-auto mb-6">
    <h4 class="text-base font-semibold mb-3 flex items-center gap-2">
      <svg class="w-6 h-6 inline text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h1.382a1 1 0 01.894.553l.447.894A2 2 0 009.447 6.447l.447.894a1 1 0 01.894.553l1.382 2.764a1 1 0 01-.553.894l-.894.447A2 2 0 0112 13.553l.894.447A1 1 0 0113.553 16l.447.894a1 1 0 01.894.553H20a1 1 0 011 1v1"></path></svg>
      AI Menu Suggestions
    </h4>
    <div id="menuSuggestPopupContent" class="text-sm text-gray-700"></div>
    <button id="menuSuggestPopupClose" class="mt-5 w-full px-4 py-2 rounded-lg border text-gray-700 bg-gray-100">Close</button>
  </div>
</div>
<script>
const APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx7Skuc9-AdvYsnYqs9qVSF90kCn7eJtP20U0BUTNeUVvcO0qtc98fdhArmUsxUYf1bUA/exec";
const apiGet = async (params)=>{
  const res = await fetch(APP_SCRIPT_URL + "?" + new URLSearchParams(params));
  const txt = await res.text();
  try { return JSON.parse(txt); }
  catch { return { success:false, message:txt }; }
};
const escapeHtml = s => String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
function placeholderImg(){
  return `data:image/svg+xml;utf8,${encodeURIComponent("<svg xmlns='http://www.w3.org/2000/svg' width='600' height='600'><rect width='100%' height='100%' fill='#f3f3f3'/></svg>")}`;
}
function showBanner(msg, type="success") {
  const b = document.getElementById("banner");
  b.textContent = msg;
  b.className = `banner ${type} show`;
  setTimeout(()=> b.className="banner", 2200);
}
async function loadInventory(){
  const marketplace = document.getElementById("marketplace");
  marketplace.innerHTML = "Loading...";
  const r = await apiGet({ action:"fetchInventory" });
  if(!r.success) return marketplace.innerHTML="Error loading";
  if(!r.items.length) return marketplace.innerHTML = "<div>No items found.</div>";
  marketplace.innerHTML="";
  r.items.forEach(it=>{
    const img = it.image ? escapeHtml(it.image) : placeholderImg();
    const card = document.createElement("div");
    card.className = "product";
    card.innerHTML = `
      <div class="prod-media">
        <img src="${img}" onerror="this.src='${placeholderImg()}'" alt="${escapeHtml(it.item)} product" loading="lazy">
      </div>
      <div class="prod-body">
        <div class="text-base font-semibold truncate">${escapeHtml(it.item)}</div>
        <div class="text-xs text-gray-500">${escapeHtml(it.ownerEmail || "")}</div>
        <div class="text-sm text-gray-500">Stock: ${escapeHtml(it.stock)} ${escapeHtml(it.unit||'kg')}</div>
        <div class="text-xl font-bold text-red-600">₹${escapeHtml(it.price)}/${escapeHtml(it.unit||'kg')}</div>
      </div>
      <div class="prod-actions">
        <div class="flex gap-2">
          <input type="number" min="1" value="1" class="w-16 border rounded text-center quantity-input" data-item="${escapeHtml(it.id)}">
          <span class="pl-1 text-xs text-gray-600">${escapeHtml(it.unit||'kg')}</span>
        </div>
        <button class="prod-btn bg-gray-800 text-white btn-order" data-id="${escapeHtml(it.id)}" data-seller="${escapeHtml(it.ownerEmail)}">Order Now</button>
        <button class="prod-btn bg-red-600 text-white btn-add" data-id="${escapeHtml(it.id)}" data-seller="${escapeHtml(it.ownerEmail)}">Add to Cart</button>
      </div>
    `;
    card.querySelector(".btn-add").onclick = ()=> addToCart(it,card);
    card.querySelector(".btn-order").onclick = ()=> orderItem(it,card);
    marketplace.appendChild(card);
  });
}
let CART = [];
function addToCart(it, card){
  let qty = 1;
  const qtyInput = card.querySelector("input.quantity-input");
  if(qtyInput && qtyInput.value) qty = Math.max(1, Number(qtyInput.value));
  const exist = CART.find(p => p.item===it.item && p.unit === it.unit);
  if(exist) exist.qty += qty;
  else CART.push({ ...it, qty:qty });
  updateCartUI();
  showBanner("Added to cart");
}
function updateCartUI(){
  document.getElementById("cartCount").textContent = "(" + CART.reduce((a,b)=>a+b.qty, 0) + ")";
}
function renderCart(){
  const box = document.getElementById("cartItems");
  if(!CART.length) return box.innerHTML="<div>Cart is empty</div>";
  box.innerHTML="";
  CART.forEach((c,i)=>{
    const row = document.createElement("div");
    row.className="p-3 border rounded mb-3 flex justify-between items-center";
    row.innerHTML = `
      <div>
        <div class="font-semibold">${escapeHtml(c.item)}</div>
        <div class="text-xs">${c.qty} × ₹${c.price} (${escapeHtml(c.unit||'kg')})</div>
      </div>
      <div class="flex gap-2">
        <button data-dec="${i}" class="px-2 border rounded">-</button>
        <button data-inc="${i}" class="px-2 border rounded">+</button>
        <button data-rem="${i}" class="px-2 text-red-600">×</button>
      </div>
    `;
    row.querySelector("[data-inc]").onclick = ()=>{
      CART[i].qty++; renderCart(); updateCartUI();
    };
    row.querySelector("[data-dec]").onclick = ()=>{
      CART[i].qty>1 ? CART[i].qty-- : CART.splice(i,1);
      renderCart(); updateCartUI();
    };
    row.querySelector("[data-rem]").onclick = ()=>{
      CART.splice(i,1); renderCart(); updateCartUI();
    };
    box.appendChild(row);
  });
  document.getElementById("cartTotal").textContent = 
    "₹" + CART.reduce((a,b)=>a+b.qty*b.price, 0);
}
document.getElementById("openCartBtn").onclick = ()=>{
  renderCart();
  document.getElementById("drawerOverlay").classList.add("show");
  document.getElementById("cartDrawer").classList.add("show");
};
document.getElementById("closeCart").onclick = ()=>{
  document.getElementById("drawerOverlay").classList.remove("show");
  document.getElementById("cartDrawer").classList.remove("show");
};
async function orderItem(it, card){
  let qty = 1;
  const qtyInput = card.querySelector("input.quantity-input");
  if(qtyInput && qtyInput.value) qty = Math.max(1, Number(qtyInput.value));
  const r = await apiGet({
    action:"placeOrder",
    sellerEmail:it.ownerEmail,
    buyerEmail:localStorage.getItem("restaurantEmail"),
    item:it.item,
    itemId:it.id,
    quantity:qty,
    unit:it.unit||'kg'
  });
  if(r.success){showBanner('Order placed','success');}else{showBanner(r.message||'Order failed','error');}
  loadInventory();
}
document.getElementById('checkoutBtn').onclick=async()=>{
  if(!CART.length)return;
  const buyerEmail = localStorage.getItem('restaurantEmail');
  let error = null;
  for(const c of CART){
    const r = await apiGet({action:'placeOrder',sellerEmail:c.ownerEmail,buyerEmail,item:c.item,itemId:c.id,quantity:c.qty,unit:c.unit||'kg'});
    if(!r.success){error=r.message||'Order error';break;}
  }
  if(!error){ CART=[]; updateCartUI(); renderCart(); showBanner("Order(s) placed!","success"); loadInventory();}
  else showBanner(error,'error');
};
function appendChat(type, text) {
  const win = document.getElementById("chatWindow");
  const div = document.createElement("div");
  div.className = "msg " + type;
  div.textContent = text;
  win.appendChild(div);
  win.scrollTop = win.scrollHeight;
}
async function sendChat(){
  const input = document.getElementById("chatInput");
  const q = input.value.trim();
  if(!q) return;
  appendChat("user", q);
  input.value="";
  appendChat("bot", "Thinking...");
  const r = await apiGet({ action:"generateRecipe", prompt:q });
  document.querySelectorAll(".msg.bot").forEach((m,i,arr)=>{
    if(i === arr.length-1) m.textContent = r.text || "I couldn't generate a response.";
  });
}
document.getElementById("openChatbot").onclick = ()=>{document.getElementById("chatPopup").classList.add("show");};
document.getElementById("closeChatbot").onclick = ()=>{document.getElementById("chatPopup").classList.remove("show");};
document.getElementById("chatSendBtn").onclick = sendChat;
document.addEventListener("DOMContentLoaded", ()=>{
  const email = localStorage.getItem("restaurantEmail");
  if(!email) location.href="restaurant_auth.html";
  document.getElementById("userEmail").textContent = email;
  loadInventory();
  document.getElementById("searchBtn").onclick = loadInventory;
  document.getElementById("logout").onclick = ()=>{
    localStorage.removeItem("restaurantEmail");
    location.href="restaurant_auth.html";
  };
});
// --- AI Menu Suggestion Assistant ---
document.getElementById("menuSuggestBtn").onclick = async function() {
  const btn = document.getElementById("menuSuggestBtn");
  btn.disabled = true; btn.textContent = "Thinking...";
  try {
    const rInventory = await apiGet({ action:"fetchInventory" });
    if(!rInventory.success || !Array.isArray(rInventory.items) || !rInventory.items.length) {
      btn.disabled = false; btn.textContent = "AI Menu Suggestions";
      showBanner("No inventory available for menu AI", "error");
      return;
    }
    const inventoryData = rInventory.items.map(({item, price, unit}) => ({item, price, unit}));
    const r = await apiGet({ action: "menuSuggest", items: JSON.stringify(inventoryData) });
    btn.disabled = false; btn.textContent = "AI Menu Suggestions";
    if(!r.success) {
      showBanner(r.message || "AI error","error");
      return;
    }
    let html = "";
    if(r.suggestions && Array.isArray(r.suggestions)){
      html += '<ol class="list-decimal ml-5 mb-2">';
      r.suggestions.forEach(dish => { html += `<li class="py-1">${dish}</li>`; });
      html += "</ol>";
    } else {
      html = (typeof r.result === "string") ? r.result : "No suggestions found.";
    }
    document.getElementById("menuSuggestPopupContent").innerHTML = html;
    document.getElementById("menuSuggestPopup").style.display = "flex";
  } catch (e) {
    btn.disabled = false; btn.textContent = "AI Menu Suggestions";
    showBanner("AI network error", "error");
  }
};
document.getElementById("menuSuggestPopupClose").onclick = function() {
  document.getElementById("menuSuggestPopup").style.display = "none";
};
</script>
</body>
</html>